<?xml version="1.0" encoding="utf-8"?>
<odoo>

  <!-- List view -->
  <record id="view_project_sprint_tree" model="ir.ui.view">
    <field name="name">project.sprint.tree</field>
    <field name="model">project.sprint</field>
    <field name="arch" type="xml">
      <tree>
        <field name="name"/>
        <field name="project_id"/>
        <field name="start_date"/>
        <field name="end_date"/>
        <field name="state"/>
      </tree>
    </field>
  </record>

  <!-- Form view -->
  <record id="view_project_sprint_form" model="ir.ui.view">
    <field name="name">project.sprint.form</field>
    <field name="model">project.sprint</field>
    <field name="arch" type="xml">
      <form>
        <header>
          <field name="state" widget="statusbar" statusbar_visible="planned,active,done"/>

          <button name="action_set_auto" type="object"
                  string="Auto" class="btn-secondary"/>

          <button name="action_set_planned" type="object"
                  string="Planned" class="btn-primary"/>

          <button name="action_set_active" type="object"
                  string="Active" class="btn-primary"/>

          <button name="action_set_done" type="object"
                  string="Done" class="btn-primary"/>

          <field name="state_mode" invisible="1"/>
          <field name="state_manual" invisible="1"/>
        </header>

        <sheet>
            <field name="task_ids" invisible="1"/>
            <group>
            <field name="name"/>
            <!-- Ensures project cannot be changed after defining tasks or sprint state is active/done
                Also ensuring when creating a new sprint the project field can never be changed to readonly to safeguard the save of the sprint
             -->
            <field name="project_id" attrs="{'readonly': [('id', '!=', False), ('state', 'in', ['active','done'])]}"/>
          </group>
          <group>
            <field name="start_date"/>
            <field name="end_date"/>
          </group>

          <notebook>
            <page string="Tasks" attrs="{'invisible': [('project_id', '=', False)]}">
                <field name="task_select_ids"
                        domain="[('project_id', '=', project_id)]"
                        context="{'default_project_id': project_id, 'from_sprint': True}">
                    <tree>
                        <field name="name"/>
                        <field name="user_ids" widget="many2many_avatar_user"/>
                        <field name="date_deadline"/>
                        <field name="stage_id"/>
                        <field name="partner_id"/>
                    </tree>
                </field>
            </page>
          </notebook>
        </sheet>
      </form>
    </field>
  </record>

  <!-- Action -->
  <record id="action_project_sprint" model="ir.actions.act_window">
    <field name="name">Sprints</field>
    <field name="res_model">project.sprint</field>
    <field name="view_mode">tree,form</field>
  </record>

  <!-- Menu (inside Project app) -->
  <menuitem id="menu_project_sprint_root"
            name="Sprints"
            parent="project.menu_main_pm"
            action="action_project_sprint"
            sequence="30"/>
</odoo>
